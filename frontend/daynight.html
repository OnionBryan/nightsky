
<!DOCTYPE html>
<!--
    World Map with Day/Night Terminator
    Version 2.0
    
    Copyright OlS (C) 2025
    
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
    
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
    
    You should have received a copy of the GNU General Public License
    along with this program. If not, see <https://www.gnu.org/licenses/>.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World Map with Day/Night Terminator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }
        
        .map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #1a2980, #26d0ce);
        }
        
        svg {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .time-label {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 16px;
            background-color: rgba(0, 0, 51, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .map-border {
            stroke: rgba(255, 255, 255, 0.5);
            stroke-width: 1;
            fill: none;
        }
        
        .country {
            fill: rgba(255, 255, 255, 0.9);
            stroke: rgba(0, 0, 139, 0.6);
            stroke-width: 0.5;
            transition: fill 0.3s;
        }
        
        .country:hover {
            fill: rgba(220, 220, 255, 1);
            stroke: rgba(0, 0, 139, 1);
            stroke-width: 1;
        }
        
        .terminator {
            fill: rgba(0, 0, 0, 0.35);
            stroke: rgba(255, 215, 0, 0.5);
            stroke-width: 1;
            stroke-dasharray: 5, 3;
            pointer-events: none; /* Allows interaction with countries beneath the terminator */
        }
        
        .country-label {
            pointer-events: none;
            z-index: 1000;
        }
        
        .sun-zenith {
            filter: drop-shadow(0 0 10px rgba(255, 255, 0, 0.8));
        }
        
        .info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 51, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-size: 14px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div class="time-label" id="time-label"></div>
        <div class="info-panel" id="info-panel">
            World Map with Day/Night Cycle
        </div>
        
        <!-- Local D3.js and TopoJSON libraries -->
        <script src="js/d3.min.js"></script>
        <script src="js/topojson.min.js"></script>
        
        <script>
            // debounce function for performance optimization
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }
            
            // Function to update map size and position
            function updateMapSize() {
                const width = window.innerWidth;
                const height = window.innerHeight;
                
                // Scale adjustment based on device
                let scaleFactor = 6;
                if (width < 768) {
                    scaleFactor = 5; // Larger scale for tablets
                }
                if (width < 480) {
                    scaleFactor = 4; // Even larger scale for mobile
                }
                
                projection
                    .scale(Math.min(width, height * 2) / scaleFactor)
                    .translate([width / 2, height / 2]);
                
                d3.select("svg")
                    .attr("width", width)
                    .attr("height", height);
                
                d3.selectAll("path").attr("d", path);
                
                // Adjust sun size based on screen size
                const sunSize = Math.max(12, Math.min(20, width / 60));
                d3.select(".sun-zenith").attr("r", sunSize);
                
                updateTerminator();
            }
            
            // Set up projection and path
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            const projection = d3.geoEquirectangular()
                .scale(Math.min(width, height * 2) / 6)
                .translate([width / 2, height / 2]);
            
            const path = d3.geoPath().projection(projection);
            
            // Create SVG element
            const svg = d3.select(".map-container").append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // Load geographical data - using a local variable for world data
            const worldData = {}; // This will be populated when data is loaded
            
            // Use a local copy of the world data instead of fetching from unpkg
            d3.json("https://unpkg.com/world-atlas@2.0.2/countries-110m.json").then(function(world) {
                // Cache the data for future use
                Object.assign(worldData, world);
                
                const countries = topojson.feature(world, world.objects.countries).features;
                
                // Add countries
                svg.selectAll(".country")
                    .data(countries)
                    .enter().append("path")
                    .attr("d", path)
                    .attr("class", "country")
                    .on("mouseover touchstart", function(event, d) {
                        event.preventDefault(); // Prevent default behavior on touch devices
                        
                        d3.select(this)
                            .style("fill", "rgba(173, 216, 230, 0.9)")
                            .style("z-index", 100);
                        
                        // Display country name
                        d3.select("#info-panel")
                            .html(d.properties.name || "Region");
                            
                        // Create temporary label with country name
                        const mouse = d3.pointer(event);
                        svg.append("text")
                            .attr("class", "country-label")
                            .attr("x", mouse[0])
                            .attr("y", mouse[1] - 10)
                            .attr("text-anchor", "middle")
                            .attr("fill", "white")
                            .attr("stroke", "black")
                            .attr("stroke-width", "0.5px")
                            .attr("font-size", function() {
                                // Responsive font size
                                const baseFontSize = Math.min(window.innerWidth, window.innerHeight) / 50;
                                return Math.max(14, Math.min(24, baseFontSize)) + "px";
                            })
                            .attr("font-weight", "bold")
                            .attr("pointer-events", "none")
                            .text(d.properties.name || "Region");
                    })
                    .on("mousemove", function(event) {
                        // Update label position
                        const mouse = d3.pointer(event);
                        svg.select(".country-label")
                            .attr("x", mouse[0])
                            .attr("y", mouse[1] - 10);
                    })
                    .on("mouseout touchend", function() {
                        d3.select(this)
                            .style("fill", null)
                            .style("z-index", null);
                        
                        d3.select("#info-panel")
                            .html("World Map with Day/Night Cycle");
                            
                        // Remove temporary label
                        svg.select(".country-label").remove();
                    });
                
                // Touch device detection
                window.addEventListener('DOMContentLoaded', function() {
                    const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                    if (isTouchDevice) {
                        document.querySelector('.map-container').classList.add('touch-device');
                        
                        // Text size adapted for touch devices
                        d3.selectAll(".country")
                            .on("touchstart", function(event, d) {
                                event.preventDefault();
                                
                                // First remove all previous selections
                                d3.selectAll(".country").style("fill", null);
                                svg.select(".country-label").remove();
                                
                                // Select the touched country
                                d3.select(this)
                                    .style("fill", "rgba(173, 216, 230, 0.9)");
                                
                                // Display country name in panel
                                d3.select("#info-panel")
                                    .html(d.properties.name || "Region");
                                
                                // Create temporary label with country name
                                const touch = d3.pointer(event);
                                svg.append("text")
                                    .attr("class", "country-label")
                                    .attr("x", touch[0])
                                    .attr("y", touch[1] - 20)
                                    .attr("text-anchor", "middle")
                                    .attr("fill", "white")
                                    .attr("stroke", "black")
                                    .attr("stroke-width", "0.5px")
                                    .attr("font-size", function() {
                                        // Responsive font size
                                        const baseFontSize = Math.min(window.innerWidth, window.innerHeight) / 40;
                                        return Math.max(16, Math.min(28, baseFontSize)) + "px";
                                    })
                                    .attr("font-weight", "bold")
                                    .attr("pointer-events", "none")
                                    .text(d.properties.name || "Region");
                            });
                    }
                });
                
                // Add map border
                svg.append("path")
                    .datum({type: "Sphere"})
                    .attr("d", path)
                    .attr("class", "map-border");
                
                // Add terminator (day/night line)
                const terminator = svg.append("path")
                    .attr("class", "terminator");
                
                // Add sun zenith point
                const sunZenith = svg.append("circle")
                    .attr("class", "sun-zenith")
                    .attr("r", 16)
                    .attr("fill", "yellow");
                
                // Cache calculated values
                let lastUpdateTime = 0;
                let cachedDeclination = 0;
                let cachedHourAngle = 0;
                
                // Function to update terminator
                function updateTerminator() {
                    const now = new Date();
                    const currentTime = now.getTime();
                    
                    // Only recalculate solar position every second to improve performance
                    if (currentTime - lastUpdateTime >= 1000) {
                        lastUpdateTime = currentTime;
                        
                        // Calculate solar declination
                        const days = (currentTime / 86400000) + 2440587.5 - 2451545;
                        cachedDeclination = 23.44 * Math.sin((2 * Math.PI / 365.25) * (days - 81));
                        
                        // Calculate hour angle
                        const millisecondsInDay = 86400000;
                        const solarTime = (now.getUTCHours() * 3600 + now.getUTCMinutes() * 60 + now.getUTCSeconds()) * 1000;
                        cachedHourAngle = 180 - (solarTime / millisecondsInDay) * 360;
                    }
                    
                    // Create terminator path
                    const terminatorPath = d3.geoCircle()
                        .center([cachedHourAngle + 180, -cachedDeclination])
                        .radius(90)
                        .precision(0.1)();
                    
                    terminator.attr("d", path(terminatorPath));
                    
                    // Update sun zenith position
                    const sunPosition = projection([cachedHourAngle, cachedDeclination]);
                    if (sunPosition) {
                        sunZenith
                            .attr("cx", sunPosition[0])
                            .attr("cy", sunPosition[1])
                            .attr("opacity", 0.8);
                    }
                    
                    // Update time display
                    const timeLabel = document.getElementById("time-label");
                    const utcHours = now.getUTCHours().toString().padStart(2, '0');
                    const utcMinutes = now.getUTCMinutes().toString().padStart(2, '0');
                    const utcSeconds = now.getUTCSeconds().toString().padStart(2, '0');
                    timeLabel.textContent = `UTC: ${utcHours}:${utcMinutes}:${utcSeconds}`;
                }
                
                // Initialize terminator and update at regular intervals
                updateTerminator();
                // Use requestAnimationFrame for smoother updates
                function animateTerminator() {
                    updateTerminator();
                    requestAnimationFrame(animateTerminator);
                }
                requestAnimationFrame(animateTerminator);
                
                // Handle window resize with debounce for better performance
                const debouncedResize = debounce(updateMapSize, 250);
                window.addEventListener('resize', debouncedResize);
                
            }).catch(function(error) {
                console.error('Error loading or processing data:', error);
                document.querySelector('.info-panel').textContent = "Data loading error";
            });
            
            // Globally define updateTerminator function
            window.updateTerminator = function() {
                // This function will be defined in the data loading context
            };
        </script>
    </div>
</body>
</html>

